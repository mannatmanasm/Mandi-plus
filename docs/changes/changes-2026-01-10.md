# Changes Log - 2026-01-10

## What Changed

### 1. ClaimRequest Entity Created
- **New Entity**: `ClaimRequest` entity for managing claim requests linked to invoices
- **Relationship**: One-to-One relationship with `Invoice` entity (each invoice can have one claim request)
- **Location**: `src/entities/claim-request.entity.ts`

### 2. Claim Status Enum
- **New Enum**: `ClaimStatus` enum with values:
  - `PENDING` - Initial status when claim is created
  - `IN_PROGRESS` - Claim is being processed
  - `SURVEYOR_ASSIGNED` - A surveyor has been assigned to the claim
  - `COMPLETED` - Claim processing is complete
- **Location**: `src/common/enums/claim-status.enum.ts`

### 3. Claim Requests Module
- **New Module**: `ClaimRequestsModule` with full CRUD functionality
- **Service**: `ClaimRequestsService` with methods for creating, filtering, updating claims
- **Controller**: `ClaimRequestsController` with admin routes and file upload endpoints
- **Location**: `src/modules/claim-requests/`

### 4. Storage Service Usage
- **Uses Existing Cloudinary Setup**: Claim requests use the existing `StorageService` with Cloudinary
- **No Changes to Upload Logic**: Upload functionality uses existing Cloudinary implementation
- **Location**: `src/modules/storage/storage.service.ts`

### 5. Database Migration
- **Created Migration**: `1768041654000-create-claim-request-entity.ts`
  - Creates `claim_status_enum` PostgreSQL enum type
  - Creates `claim_requests` table with all required fields
  - Sets up foreign key constraint to `invoices` table with CASCADE delete
  - Creates unique index on `invoiceId` (ensures one-to-one relationship)
  - Creates index on `status` for efficient querying

## API Endpoints

### 1. Create Claim Request by Truck Number
- **Endpoint**: `POST /claim-requests/by-truck`
- **Body**: `{ "truckNumber": "MH12AB1234" }`
- **Description**: Finds the latest invoice for the truck number and creates a claim request with defaults
- **Default Values**: 
  - `status`: `PENDING`
  - `supportedMedia`: `[]`
  - Other fields: `null`

### 2. Get All Claim Requests (Admin)
- **Endpoint**: `GET /claim-requests/admin`
- **Query Parameters**:
  - `status` (optional): Filter by claim status
  - `invoiceId` (optional): Filter by invoice ID
  - `truckNumber` (optional): Filter by truck number (partial match)
- **Description**: Returns all claim requests with optional filters for admin dashboard

### 3. Get Claim Request by ID
- **Endpoint**: `GET /claim-requests/:id`
- **Description**: Returns a specific claim request with invoice, truck, and user relations

### 4. Update Claim Request Status
- **Endpoint**: `PATCH /claim-requests/:id/status`
- **Body**: 
  ```json
  {
    "status": "inprogress",
    "surveyorName": "John Doe",  // Required if status is SURVEYOR_ASSIGNED
    "surveyorContact": "+919876543210",  // Required if status is SURVEYOR_ASSIGNED
    "notes": "Processing claim..."
  }
  ```
- **Description**: Updates claim status and optionally assigns surveyor or adds notes

### 5. Upload Supporting Media
- **Endpoint**: `POST /claim-requests/:id/supporting-media`
- **Content-Type**: `multipart/form-data`
- **Body**: `files` (array of files, up to 10 files, max 10MB each)
- **Supported File Types**: jpg, jpeg, png, gif, pdf, doc, docx, txt
- **Description**: Uploads supporting media files to Cloudinary and appends URLs to `supportedMedia` array
- **Storage**: Files are uploaded to `mandi-plus/claim-requests/supporting-media/` folder in Cloudinary

## Storage Configuration

### Cloudinary Environment Variables

The project uses Cloudinary for file uploads. Ensure these are set in your `.env` file:

```env
# Cloudinary Configuration
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret
```

### Storage Behavior

- **Files are uploaded to Cloudinary**: All supporting media files are uploaded to Cloudinary
- **Folder Structure**: Files are stored in `mandi-plus/claim-requests/supporting-media/` folder
- **URLs**: Returns secure URLs from Cloudinary for uploaded files

## Why It Changed

- Requirement to track and manage claim requests for invoices
- Need for structured claim processing workflow with status tracking
- Support for attaching supporting documents/media via file uploads
- Foundation for claim management features and insurance claim processing
- Need for admin dashboard with filtering capabilities

## How It Affects the Current Code

### Database Migration Required
- **NEW MIGRATION**: `1768041654000-create-claim-request-entity.ts` must be run
  ```bash
  pnpm run migration:run
  ```

### Entity Registration
- **Auto-loaded**: The `ClaimRequest` entity is automatically loaded by TypeORM (via `autoLoadEntities: true` in `app.module.ts`)
- **Module Registration**: `ClaimRequestsModule` is registered in `AppModule`

### Breaking Changes
- **None**: This is a new module, does not affect existing functionality

### Invoice Entity
- Invoice entity now has an optional `claimRequest` property
- When querying invoices, you can optionally include the claim request relation:
  ```typescript
  const invoice = await invoiceRepository.findOne({
    where: { id },
    relations: ['claimRequest'],
  });
  ```

## Developer Notes

### Next Steps

1. **Run the Migration**:
   ```bash
   pnpm run migration:run
   ```

2. **Ensure Cloudinary is configured**:
   - Verify `CLOUDINARY_CLOUD_NAME`, `CLOUDINARY_API_KEY`, and `CLOUDINARY_API_SECRET` are set in `.env`

3. **Test Endpoints**:
   - Create a claim request by truck number
   - Upload supporting media files
   - Update claim status
   - Filter claim requests by status, invoice, or truck

### Example Usage

#### Create Claim Request by Truck Number

```bash
POST /claim-requests/by-truck
Content-Type: application/json

{
  "truckNumber": "MH12AB1234"
}
```

Response:
```json
{
  "id": "claim-uuid",
  "status": "pending",
  "supportedMedia": [],
  "claimFormUrl": null,
  "description": null,
  "claimAmount": null,
  "invoice": {
    "id": "invoice-uuid",
    "invoiceNumber": "INV-2024-001",
    ...
  },
  "createdAt": "2026-01-10T12:00:00Z",
  "updatedAt": "2026-01-10T12:00:00Z"
}
```

#### Upload Supporting Media

```bash
POST /claim-requests/{id}/supporting-media
Content-Type: multipart/form-data

files: [file1.jpg, file2.pdf]
```

#### Update Status

```bash
PATCH /claim-requests/{id}/status
Content-Type: application/json

{
  "status": "surveyor_assigned",
  "surveyorName": "John Doe",
  "surveyorContact": "+919876543210",
  "notes": "Surveyor assigned for site visit"
}
```

#### Filter Claims (Admin)

```bash
GET /claim-requests/admin?status=pending&truckNumber=MH12
```

### Migration Rollback

If you need to rollback this migration:
```bash
pnpm run migration:revert
```

This will:
- Drop the `claim_requests` table
- Drop the foreign key constraint
- Drop all indexes
- Drop the `claim_status_enum` type

## Future Enhancements

1. **Claim Form Upload**: Add endpoint for uploading claim form PDFs
2. **Claim Amount Update**: Add endpoint to update claim amount
3. **Claim History**: Track status change history with timestamps
4. **Notifications**: Notify users when claim status changes
5. **Surveyor Entity**: Link to a Surveyor entity instead of storing name/contact as strings
6. **Bulk Operations**: Add endpoints for bulk status updates
7. **Claim Reports**: Generate reports for claims by status, date range, etc.
