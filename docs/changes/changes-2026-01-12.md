# Changes Log - 2026-01-12

## What Changed

### 1. Damage Certificate (Claim Form) Feature

- **New DTO**: `CreateDamageFormDto` (`damage-certificate` payload fields)
- **New Service Method**: `ClaimRequestsService.createDamageFormAndQueuePdf()`
  - Validates `ClaimRequest` exists and is linked to an `Invoice`
  - Uses invoice relations (invoice number, truck number, user mobile)
  - Queues a `claim-form-pdf` BullMQ job with damage form details
- **New Queue & Processor**:
  - Registered new queue: `claim-form-pdf`
  - Added `ClaimFormPdfProcessor` (`src/modules/queue/processors/claim-form-pdf.processor.ts`)
  - Generates a damage certificate PDF using `PdfService.generateDamageCertificatePdf()`
  - Uploads PDF via existing `StorageService.uploadPdf()` (Cloudinary)
  - Stores resulting URL in `ClaimRequest.claimFormUrl`

- **PDF Service**:
  - Added `PdfService.generateDamageCertificatePdf(payload)` that renders a single-page damage certificate:
    - Heading: `DAMAGE CERTIFICATE (from Transporter Agent / Owner)`
    - Lines for memo number, dates, product, parties, accident details
    - Agreed damage amount (number + words) and authorized signatory
    - Includes contact (user mobile) in footer

- **New Endpoint**:
  - `POST /claim-requests/:id/damage-form`
    - Body: `CreateDamageFormDto` fields
    - Returns HTTP 202 and queues PDF generation

## Why It Changed

- Needed a formal **damage certificate PDF** for each claim request, matching the transporterâ€™s paper form.
- Required an API for frontend to submit damage-form data while reusing existing invoice relationships:
  - Invoice number
  - Truck number
  - User mobile number
- Required storing the generated PDF URL on the `ClaimRequest` record for later viewing/download.

## How It Affects the Current Code

- **ClaimRequest Entity**:
  - Already has `claimFormUrl` field; now it gets populated by the new processor.

- **ClaimRequests Module**:
  - Imports `QueueModule` and `PdfModule`
  - Registers `ClaimFormPdfProcessor` as a provider

- **Queue Module**:
  - Registers an additional queue: `claim-form-pdf`

- **ClaimRequests Controller**:
  - New route: `POST /claim-requests/:id/damage-form`
    - Accepts JSON body with damage form details
    - Returns a message and `claimRequestId`

- **Background Processing**:
  - Follows same async pattern as invoice PDF:
    - API returns immediately (202)
    - PDF generation happens in background
    - `claimFormUrl` is updated when ready

## Developer Notes

### 1. API Usage

**Submit damage form for a claim request:**

```http
POST /claim-requests/{claimRequestId}/damage-form
Content-Type: application/json

{
  "damageCertificateDate": "2026-01-09",
  "transportReceiptMemoNo": "Memo No 416",
  "transportReceiptDate": "2026-01-07",
  "loadedWeightKg": 15400,
  "productName": "Sweet Potato",
  "fromParty": "Sandeep Yadav, Hassan, Karnataka, India",
  "forParty": "KSRT AGROMART PVT LTD, Muhana Mandi, Jaipur, RJ",
  "accidentDate": "2026-01-09",
  "accidentLocation": "Aurangabad-Solapur Highway, Pachdol (MH) 431121",
  "accidentDescription": "Vehicle collided with another vehicle. Goods shattered and damaged.",
  "agreedDamageAmountNumber": 50000,
  "agreedDamageAmountWords": "Fifty Thousand Only",
  "authorizedSignatoryName": "Subramanya T R"
}
```

**Response:**

```json
{
  "message": "Damage form accepted. PDF generation queued.",
  "claimRequestId": "claim-request-uuid"
}
```

Later, when the processor completes, `claimFormUrl` on the claim request will contain the Cloudinary PDF URL.

### 2. PDF Layout

- Follows the sample damage certificate structure:
  - Certificate heading
  - Loaded weight, product, from/to parties
  - Invoice number and truck number
  - Accident date, place, and description
  - Agreed damages section (number + words)
  - Authorized signatory line (from payload)
  - Contact (user mobile) in footer

### 3. Testing Checklist

- Ensure Redis is running (BullMQ).
- Create an invoice and claim request.
- Call `POST /claim-requests/:id/damage-form` with sample payload.
- Verify:
  - Job appears in `claim-form-pdf` queue.
  - A new PDF file is uploaded to Cloudinary under `mandi-plus/claim-forms/`.
  - `claimFormUrl` is populated on the corresponding `ClaimRequest`.


